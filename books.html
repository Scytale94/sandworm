<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Books Hub</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  :root{
    --bg:#2a1b2e;
    --section-bg: #3b2640;
    --card: #3b2640;
    --muted:#dcdcdc;
    --accent:#f3e5f5;
    --gold:#ffd369;
    --glass: rgba(255,255,255,0.06);
  }
  html,body{
    height:100%;
    margin:0;
    font-family: "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
    background: linear-gradient(135deg,#2a1b2e,#2a1b2e);
    color:#f3e5f5;
  }
  header{
    padding:18px;
    text-align:center;
    background: rgba(0,0,0,0.25);
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  }
  header h1{
    margin:0;
    font-family: "Orbitron", sans-serif;
    font-size:2rem;
    color:var(--accent);
    letter-spacing:1px;
  }
  main{
    max-width:980px;
    margin:28px auto;
    padding:0 18px 80px 18px;
  }
  .section{
    background:var(--section-bg);
    padding:18px;
    border-radius:12px;
    margin-bottom:24px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.35);
  }
  .section h2{
    margin:0 0 12px 0;
    display:inline-block;
    font-size:1.15rem;
    border-bottom:2px solid var(--accent);
    padding-bottom:6px;
  }
  .shelf-grid{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:8px;
  }
  .book-card{
    background:var(--card);
    width:105px;
    min-width:100px;
    border-radius:8px;
    padding:6px;
    text-align:center;
    box-shadow:0 3px 8px rgba(0,0,0,0.4);
    transition: transform .15s, box-shadow .15s;
  }
  .book-card:hover{
    transform: translateY(-3px);
    box-shadow:0 8px 18px rgba(0,0,0,0.55);
  }
  .book-cover{
    width:100%;
    height:140px;
    object-fit:cover;
    border-radius:5px;
    background: linear-gradient(180deg,#333,#222);
  }
  .book-title{
    font-weight:600;
    font-size:0.8rem;
    margin:6px 0 3px 0;
    min-height:32px;
  }
  .book-author{
    font-size:0.7rem;
    color:var(--muted);
    margin-bottom:4px;
  }
  .small-link{
    display:inline-block;
    margin-top:4px;
    color:var(--gold);
    text-decoration:none;
    font-size:0.7rem;
  }

  /* Read books table */
  .table-controls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:12px;
    align-items:center;
  }
  .table-controls input[type="text"], .table-controls input[type="number"]{
    padding:8px 10px;
    border-radius:8px;
    border:0;
    background:var(--glass);
    color:var(--muted);
  }
  .table-controls button{
    padding:8px 12px;
    border-radius:8px;
    border:0;
    background:var(--accent);
    color:#fff;
    cursor:pointer;
    font-weight:600;
  }
  table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    background: transparent;
    color:var(--muted);
  }
  th, td{
    padding:10px 8px;
    text-align:left;
    border-bottom:1px solid rgba(255,255,255,0.04);
  }
  th{
    color:#fff;
    font-weight:700;
    font-size:0.95rem;
  }
  td .small{
    display:block;
    color:var(--muted);
    font-size:0.88rem;
  }
  .action-btn{
    background:transparent;
    border:1px solid rgba(255,255,255,0.06);
    color:var(--muted);
    padding:6px 8px;
    border-radius:8px;
    cursor:pointer;
    margin-left:6px;
  }
  .muted-note{
    color:var(--muted);
    font-size:0.9rem;
    margin-top:8px;
  }
  .back{
    display:inline-block;
    margin-top:12px;
    color:var(--gold);
    text-decoration:none;
  }

  @media (max-width:720px){
    .book-cover{height:120px}
    .book-card{width:31%}
  }
</style>
</head>
<body>
  <header>
    <h1><i class="fa-solid fa-book"></i> Books Hub</h1>
  </header>

  <main>
    <a class="back" href="index.html"><i class="fa-solid fa-arrow-left"></i> Back to Command Deck</a>

    <!-- Currently Reading -->
    <section id="currently-reading-section" class="section">
      <h2><i class="fa-solid fa-book-open-reader"></i> Currently Reading</h2>
      <div id="currently-reading" class="shelf-grid">
        <div class="book-card">Loading…</div>
      </div>
    </section>

    <!-- Want to Read -->
    <section id="to-read-section" class="section">
      <h2><i class="fa-solid fa-book-reader"></i> Want to Read</h2>
      <div id="to-read" class="shelf-grid">
        <div class="book-card">Loading…</div>
      </div>
    </section>

    <!-- Read Books Table -->
    <section id="read-section" class="section">
      <h2><i class="fa-solid fa-check-circle"></i> Read Books (Your Records)</h2>

      <div class="table-controls">
        <input id="input-title" type="text" placeholder="Title (required)"/>
        <input id="input-author" type="text" placeholder="Author"/>
        <input id="input-rating" type="number" step="0.1" min="0" max="10" placeholder="Rating (0.0 - 10.0)"/>
        <button id="add-book">Add</button>
      </div>

      <div class="muted-note">Add books you've finished. Ratings are 0.0–10.0. Edits and deletions are saved locally.</div>

      <table id="read-table" aria-live="polite">
        <thead>
          <tr><th>Title</th><th>Author</th><th>Rating</th><th>Date Added</th><th style="width:140px">Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

<script>
const GOODREADS_USER_ID = '145950633';
const GOODSHELF_BASE = 'https://www.goodreads.com/review/list_rss/' + GOODREADS_USER_ID + '?shelf=';
const ALL_ORIGINS = 'https://api.allorigins.win/raw?url=';

function proxyUrl(url){ return ALL_ORIGINS + encodeURIComponent(url); }
function escapeHtml(str){
  if(!str) return '';
  return str.replace(/[&<>"']/g, ch=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[ch]));
}

// Fetch Goodreads shelves
async function fetchShelf(shelf){
  const feedUrl = GOODSHELF_BASE + encodeURIComponent(shelf);
  try{
    const resp = await fetch(proxyUrl(feedUrl));
    const text = await resp.text();
    const xml = new DOMParser().parseFromString(text, 'application/xml');
    const items = Array.from(xml.querySelectorAll('item'));
    return items.map(it=>{
      const title = (it.querySelector('title') && it.querySelector('title').textContent) || 'Untitled';
      let author = '';
      const authorNode = it.querySelector('author name') || it.querySelector('author');
      if(authorNode) author = authorNode.textContent.trim();
      else {
        const m = title.match(/\s+by\s+(.+)$/i);
        if(m) author = m[1].trim();
      }
      const link = it.querySelector('link') ? it.querySelector('link').textContent : '';
      let cover = '';
      const desc = it.querySelector('description')?.textContent || '';
      const m = desc.match(/<img[^>]+src=["']([^"']+)["']/i);
      if(m) cover = m[1];
      return { title, author, link, cover };
    });
  }catch(err){
    console.error(err);
    return null;
  }
}

function renderShelf(containerId, books){
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  if(!books || books.length === 0){
    container.innerHTML = '<div class="book-card">No books found.</div>';
    return;
  }
  books.forEach(b=>{
    const card = document.createElement('div');
    card.className = 'book-card';
    const coverHtml = b.cover ? `<img class="book-cover" src="${b.cover}" alt="${escapeHtml(b.title)}">`
                              : `<div class="book-cover" style="display:flex;align-items:center;justify-content:center;color:#ddd;font-size:0.7rem">No cover</div>`;
    card.innerHTML = `
      ${coverHtml}
      <div class="book-title">${escapeHtml(b.title)}</div>
      <div class="book-author">${escapeHtml(b.author)}</div>
      <a class="small-link" href="${b.link}" target="_blank">View</a>
    `;
    container.appendChild(card);
  });
}

async function loadShelves(){
  renderShelf('currently-reading', await fetchShelf('currently-reading'));
  renderShelf('to-read', await fetchShelf('to-read'));
}
loadShelves();

// Read Books table (localStorage)
const STORAGE_KEY = 'booksHub.readBooks.v2';
let readBooks = [];
const tbody = document.querySelector('#read-table tbody');
const inputTitle = document.getElementById('input-title');
const inputAuthor = document.getElementById('input-author');
const inputRating = document.getElementById('input-rating');

function saveBooks(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(readBooks)); }
function loadBooks(){
  const raw = localStorage.getItem(STORAGE_KEY);
  readBooks = raw ? JSON.parse(raw) : [];
}
function renderTable(){
  tbody.innerHTML = '';
  if(readBooks.length === 0){
    tbody.innerHTML = '<tr><td colspan="5" style="color:var(--muted)">No entries yet.</td></tr>';
    return;
  }
  readBooks.forEach((b,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${escapeHtml(b.title)}</strong></td>
      <td>${escapeHtml(b.author||'')}</td>
      <td>${b.rating !== undefined && b.rating !== null ? Number(b.rating).toFixed(1) : ''}</td>
      <td>${b.addedAt ? new Date(b.addedAt).toLocaleDateString() : ''}</td>
      <td>
        <button class="action-btn" data-act="edit" data-i="${i}"><i class="fa-solid fa-pen"></i> Edit</button>
        <button class="action-btn" data-act="del" data-i="${i}"><i class="fa-solid fa-trash"></i> Del</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

document.getElementById('add-book').addEventListener('click', ()=>{
  const title = inputTitle.value.trim();
  if(!title){ alert('Enter a title'); return; }
  const author = inputAuthor.value.trim();
  let rating = inputRating.value.trim();
  rating = rating ? parseFloat(rating) : null;
  if(rating!==null && (isNaN(rating)||rating<0||rating>10)){ alert('Rating must be between 0–10'); return; }
  readBooks.unshift({title,author,rating,addedAt:new Date().toISOString()});
  saveBooks();
  renderTable();
  inputTitle.value = inputAuthor.value = inputRating.value = '';
});

tbody.addEventListener('click', e=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  const act = btn.dataset.act;
  const i = Number(btn.dataset.i);
  if(act==='del'){
    if(confirm('Delete this entry?')){ readBooks.splice(i,1); saveBooks(); renderTable(); }
  }else if(act==='edit'){
    const b = readBooks[i];
    const newTitle = prompt('Title', b.title) || b.title;
    const newAuthor = prompt('Author', b.author || '') || b.author;
    let newRating = prompt('Rating (0.0–10.0)', b.rating ?? '');
    if(newRating==='') newRating=null;
    else {
      newRating=parseFloat(newRating);
      if(isNaN(newRating)||newRating<0||newRating>10){alert('Invalid rating');return;}
    }
    b.title=newTitle.trim(); b.author=newAuthor.trim(); b.rating=newRating;
    saveBooks(); renderTable();
  }
});

loadBooks();
renderTable();
</script>
</body>
</html>
