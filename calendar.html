<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calendar Hub</title>
<style>
:root {
  --bg: #2a1b2e;
  --section-bg: #3b2640;
  --card-bg: #4b2b50;
  --text: #f3e5f5;
  --muted: #dcdcdc;
  --accent: #8e24aa;
  --hover: #7b1fa2;
  --work: #d32f2f;
  --personal: #fbc02d;
  --family: #388e3c;
  --holiday: #1976d2;
}
body {
  margin:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg); color: var(--text);
}
header {
  background: var(--section-bg); text-align:center; padding:20px;
}
header h1 { margin:0; font-size:2em; }
button { 
  cursor:pointer; border:none; padding:6px 12px; border-radius:6px; background:var(--accent); color:#fff;
}
button:hover { background:var(--hover); }
nav { display:flex; justify-content:space-between; margin:15px 20px; flex-wrap:wrap; gap:10px; }
.calendar-container { max-width:1000px; margin:0 auto 50px; }
.calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:2px; background:var(--section-bg); border-radius:10px; padding:5px; }
.day-header { text-align:center; padding:5px 0; font-weight:bold; }
.date-cell { min-height:100px; background:var(--card-bg); padding:4px; border-radius:6px; position:relative; cursor:pointer; overflow:hidden; }
.date-number { font-weight:bold; margin-bottom:2px; }
.event { padding:2px 4px; margin:1px 0; border-radius:4px; font-size:0.8em; color:#fff; cursor:pointer; }
.event.work { background:var(--work); }
.event.personal { background:var(--personal); }
.event.family { background:var(--family); }
.event.holiday { background:var(--holiday); }
.popup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; display:none; z-index:999; }
.popup-content { background:var(--section-bg); padding:20px; border-radius:12px; width:300px; max-width:90%; color:var(--text); position:relative; }
.popup-content h2 { margin-top:0; }
.popup-content label { display:block; margin-top:10px; font-size:0.9em; }
.popup-content input, .popup-content select { width:100%; padding:6px; border-radius:6px; border:none; background:var(--card-bg); color:var(--text); margin-top:3px; }
.popup-content .actions { margin-top:15px; display:flex; justify-content:space-between; }
.close-btn { position:absolute; top:10px; right:10px; cursor:pointer; font-weight:bold; font-size:1.2em; }
</style>
</head>
<body>
<header>
  <h1>Calendar Hub</h1>
  <a href="index.html" style="color:var(--text); text-decoration:none;">&larr; Back to Home</a>
</header>

<nav>
  <div>
    <button id="prevMonth">Previous Month</button>
    <button id="nextMonth">Next Month</button>
  </div>
  <div>
    <button id="exportCSV">Export CSV</button>
    <input type="file" id="importCSV" style="display:none;">
    <button onclick="document.getElementById('importCSV').click()">Import CSV</button>
  </div>
</nav>

<div class="calendar-container">
  <div class="calendar" id="calendar"></div>
</div>

<div class="popup" id="eventPopup">
  <div class="popup-content">
    <span class="close-btn" onclick="closePopup()">Ã—</span>
    <h2 id="popupTitle">Add Event</h2>
    <label>Event Name: <input type="text" id="eventName"></label>
    <label>Category:
      <select id="eventCategory">
        <option value="work">Work</option>
        <option value="personal">Personal</option>
        <option value="family">Family</option>
      </select>
    </label>
    <label>All Day: <input type="checkbox" id="eventAllDay"></label>
    <label>Start Time: <input type="time" id="eventTime"></label>
    <label>Recurring:
      <select id="eventRecurrence">
        <option value="none">None</option>
        <option value="monthly">Monthly</option>
        <option value="annual">Annual</option>
      </select>
    </label>
    <div class="actions">
      <button id="saveEventBtn">Save</button>
      <button onclick="closePopup()">Cancel</button>
    </div>
  </div>
</div>

<script>
const calendarEl = document.getElementById('calendar');
const eventPopup = document.getElementById('eventPopup');
const eventNameInput = document.getElementById('eventName');
const eventCategoryInput = document.getElementById('eventCategory');
const eventAllDayInput = document.getElementById('eventAllDay');
const eventTimeInput = document.getElementById('eventTime');
const eventRecInput = document.getElementById('eventRecurrence');
let events = [];
let editingEventIndex = null;

let today = new Date();
let currentMonth = today.getMonth();
let currentYear = today.getFullYear();

const holidays = [
  {name:'New Year\'s Day', month:0, day:1},
  {name:'MLK Day', month:0, week:3, weekday:1}, // 3rd Monday Jan
  {name:'Memorial Day', month:4, week:-1, weekday:1}, // last Monday May
  {name:'Independence Day', month:6, day:4},
  {name:'Labor Day', month:8, week:1, weekday:1}, // 1st Monday Sep
  {name:'Halloween', month:9, day:31},
  {name:'Thanksgiving', month:10, week:4, weekday:4}, // 4th Thursday Nov
  {name:'Black Friday', month:10, week:4, weekday:5}, // Friday after Thanksgiving
  {name:'Christmas Eve', month:11, day:24},
  {name:'Christmas Day', month:11, day:25}
];

function getHolidayDate(holiday, year){
  if(holiday.day!==undefined) return new Date(year,holiday.month,holiday.day);
  const month = holiday.month;
  const weekday = holiday.weekday;
  const week = holiday.week;
  const firstDay = new Date(year,month,1);
  let day = 1 + (7 + weekday - firstDay.getDay()) % 7;
  if(week>0) day += 7*(week-1);
  else{ // last week
    const lastDay = new Date(year,month+1,0);
    const lastWeekday = lastDay.getDay();
    day = lastDay.getDate() - ((7 + lastWeekday - weekday) % 7);
  }
  return new Date(year,month,day);
}

function format12Hour(timeStr){
  if(!timeStr) return '';
  let [h,m] = timeStr.split(':').map(Number);
  const ampm = h>=12 ? 'PM':'AM';
  h = h%12 || 12;
  return `${h}:${m.toString().padStart(2,'0')} ${ampm}`;
}

function openPopup(date, eventIndex=null){
  editingEventIndex = eventIndex;
  eventNameInput.value = '';
  eventCategoryInput.value = 'work';
  eventAllDayInput.checked = false;
  eventTimeInput.value = '';
  eventRecInput.value = 'none';
  if(eventIndex!==null){
    const ev = events[eventIndex];
    eventNameInput.value = ev.name;
    eventCategoryInput.value = ev.category;
    eventAllDayInput.checked = ev.allday;
    eventTimeInput.value = ev.time||'';
    eventRecInput.value = ev.rec||'none';
  }
  eventPopup.style.display='flex';
  setTimeout(()=>eventNameInput.focus(),100);
}

function closePopup(){ eventPopup.style.display='none'; editingEventIndex=null; }

function addEvent(date){
  openPopup(date);
}

function saveEvent(){
  const ev = {
    name:eventNameInput.value.trim(),
    category:eventCategoryInput.value,
    allday:eventAllDayInput.checked,
    time:eventTimeInput.value,
    rec:eventRecInput.value,
    date:{year:currentYear, month:currentMonth}
  };
  if(!ev.name) return;
  if(editingEventIndex!==null) events[editingEventIndex]=ev;
  else events.push(ev);
  renderCalendar();
  closePopup();
}

document.getElementById('saveEventBtn').addEventListener('click',saveEvent);
document.getElementById('prevMonth').addEventListener('click',()=>{currentMonth--; if(currentMonth<0){currentMonth=11; currentYear--;} renderCalendar();});
document.getElementById('nextMonth').addEventListener('click',()=>{currentMonth++; if(currentMonth>11){currentMonth=0; currentYear++;} renderCalendar();});

function exportCSV(){
  const csv = events.map(ev=>{
    return [ev.name,ev.category,ev.allday,ev.time,ev.rec,ev.date.year,ev.date.month].join(',');
  }).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='calendar_events.csv'; a.click();
  URL.revokeObjectURL(url);
}

document.getElementById('exportCSV').addEventListener('click',exportCSV);
document.getElementById('importCSV').addEventListener('change',function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload=function(evt){
    const lines = evt.target.result.split('\n');
    events = lines.map(l=>{
      const [name,category,allday,time,rec,year,month]=l.split(',');
      return {name,category,allday:allday==='true',time,rec, date:{year:+year, month:+month}};
    });
    renderCalendar();
  };
  reader.readAsText(file);
  e.target.value='';
});

function getEventsForDay(y,m,d){
  const dayEvents=[];
  events.forEach(ev=>{
    let include=false;
    if(ev.rec==='none'){
      include = ev.date.year===y && ev.date.month===m && ev.date.day===d;
    } else if(ev.rec==='monthly'){
      include = ev.date.day===d;
    } else if(ev.rec==='annual'){
      include = ev.date.month===m && ev.date.day===d;
    }
    if(include) dayEvents.push(ev);
  });

  // All Day first, then timed events sorted by 12-hour time
  dayEvents.sort((a,b)=>{
    if(a.allday && !b.allday) return -1;
    if(!a.allday && b.allday) return 1;
    if(!a.allday && !b.allday){
      const t1 = a.time||'00:00';
      const t2 = b.time||'00:00';
      return t1.localeCompare(t2);
    }
    return 0;
  });
  return dayEvents;
}

function renderCalendar(){
  calendarEl.innerHTML='';
  const monthStart = new Date(currentYear,currentMonth,1);
  const monthEnd = new Date(currentYear,currentMonth+1,0);
  const startDay = monthStart.getDay();
  const totalDays = monthEnd.getDate();

  const daysOfWeek=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  daysOfWeek.forEach(d=>{
    const dh = document.createElement('div'); dh.className='day-header'; dh.innerText=d; calendarEl.appendChild(dh);
  });

  for(let i=0;i<startDay;i++){
    const empty = document.createElement('div'); empty.className='date-cell'; calendarEl.appendChild(empty);
  }

  for(let d=1;d<=totalDays;d++){
    const cell = document.createElement('div'); cell.className='date-cell';
    cell.dataset.day=d;
    const num = document.createElement('div'); num.className='date-number'; num.innerText=d; cell.appendChild(num);

    // check holidays
    holidays.forEach(h=>{
      const hdate = getHolidayDate(h,currentYear);
      if(hdate.getDate()===d && hdate.getMonth()===currentMonth){
        const hEl = document.createElement('div');
        hEl.className='event holiday'; hEl.innerText=h.name;
        cell.appendChild(hEl);
      }
    });

    const dayEvents = getEventsForDay(currentYear,currentMonth,d);
    dayEvents.forEach((ev,i)=>{
      const eDiv = document.createElement('div');
      eDiv.className='event '+ev.category;
      eDiv.innerText = (ev.allday?'[All Day] ':'') + (ev.time?format12Hour(ev.time)+' ':'') + ev.name;
      eDiv.onclick=()=>editEvent(d,ev);
      cell.appendChild(eDiv);
    });

    cell.onclick=(e)=>{
      if(e.target===cell) openPopup(d);
    };

    calendarEl.appendChild(cell);
  }
}

function editEvent(day,ev){
  const idx = events.indexOf(ev);
  openPopup(day,idx);
}

renderCalendar();
</script>
</body>
</html>
